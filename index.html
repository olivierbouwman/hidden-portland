<!DOCTYPE html>
<html>
<head>
    <title>Hidden Portland for the Curious</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="leaflet/leaflet.css"/>
    <script src="leaflet/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        html, body, #map {
            height: 100%;
            width: 80vw;
        }
        #filters {
            width: 20vw;
            margin-left: -100px;
            float: right;
            background-color: white;
        }
    </style>
</head>
<body>
    <div id="info">
        <p>This map shows posts from <a target="_blank" href="https://www.facebook.com/groups/Hiddenportlandforthecurious">Hidden Portland for the Curious</a>. Only posts that could automatically be located are included, not all locations will be corcect.</p>
    </div>
    <div id="filters">
        <div class="filter-years">
            <label for="years">Years</label>
            <select name="years" id="years" multiple onchange="updateMarkers()"></select>
        </div>
        <div class="filter-likes">
            <label for="likes" id="likes-label">Likes (at least 0)</label>
            <input name="likes" id="likes" type="range" min="0" max="10" onchange="updateMarkers()">
        </div>
        <div class="filter-search">
            <label for="search">Search</label>
            <input name="search" id="search" type="text" onchange="updateMarkers()">
        </div>
    </div>
    <div id="map"></div>
    <script>
        var likesMax = 0;
        var years = [];
        var mapData = [];
        var map;
        var markersLayer = new L.LayerGroup();
        $.getJSON("data-live.json", function(jsondata) {
            $.each(jsondata, function(index, element) {
                if (element.latlong !== undefined) {
                    // We can map this, add it to our list.
                    mapData.push(element);
                    // Find all years.
                    if (Number.isInteger(Number(element.date.substring(0,4))) && years.indexOf(element.date.substring(0,4)) === -1) {
                        years.push(element.date.substring(0,4));
                        select = document.getElementById('years');
                        var opt = document.createElement('option');
                        opt.value = element.date.substring(0,4);
                        opt.innerHTML = element.date.substring(0,4);
                        select.appendChild(opt);
                    }
                    // Find highest number of likes.
                    if (!isNaN(Number(element.likes))) {
                        likesMax = Math.max(likesMax, Number(element.likes));
                    }
                }
            });
            document.getElementById("likes").max = likesMax;
            document.getElementById("likes").value = 0;
            // Enable 2 most recent years;
            document.getElementById("years").options[0].selected = true;
            document.getElementById("years").options[1].selected = true;
            updateMarkers();
        });

        function updateMarkers() {
            // Update likes value.
            document.getElementById('likes-label').innerText = "Likes (at least " + document.getElementById('likes').value + ")"
            // Clear all markers.
            markersLayer.clearLayers();
            var search = document.getElementById('search').value;
            $.each(mapData, function(index, element) {
                for (var option of document.getElementById('years').options) {
                    if (option.selected && option.value == element.date.substring(0,4)) {
                        if (search.length === 0 || (search.length > 0 && element.text.toLowerCase().includes(search.toLowerCase()))) {
                            if (Number(element.likes) >= document.getElementById('likes').value) {
                                var marker = L.marker([element.latlong.lat,element.latlong.lng]);
                                // marker.setOpacity(element.likes / likesMax);
                                marker.bindPopup('likes: ' + element.likes + ' / date: ' + element.date + '<br><a target="_blank" href="https://www.facebook.com/groups/Hiddenportlandforthecurious/posts/' + element.id + '">' + element.text + '</a>');
                                markersLayer.addLayer(marker);
                            }
                        }
                    }
                }
            });
            markersLayer.addTo(map);
        }

        map = L.map('map').setView([45.5428128,-122.7244404], 12);
        var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib2xpdmllcmJvdXdtYW4iLCJhIjoickVlQjBPcyJ9.1yW9yNkaVPQLxet0VsSSBA', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);
    </script>
</body>
</html>
