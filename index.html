<!DOCTYPE html>
<html>
<head>
    <title>Hidden Portland for the Curious Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="leaflet/leaflet.css"/>
    <script src="leaflet/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        html, body {
            margin: 0px;
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #filters {
            position: absolute;
            right: 0px;
            top: 0px;
            z-index: 500;
            background-color: rgba(255,255,255,0.8);
            padding-bottom: 4px;
            padding-top: 4px;
            padding-left: 4px;
            padding-right: 4px;
            margin-left: 60px;
            text-align: right;
        }
        #filters label {
            display: block;
            padding-bottom: 10px;
            white-space: nowrap;
        }
    </style>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G1HN96YZ99"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-G1HN96YZ99');
    </script>
</head>
<body>
    <div id="map"></div>
    <div id="filters">
        <label for="years" id="years-label"><span id="years-text">Years (starting at 0)</span><input name="years" id="years" type="range" min="0" max="0" onchange="updateYears();"></label>
        <label for="likes" id="likes-label"><span id="likes-text">Likes (at least 0)</span><input name="likes" id="likes" type="range" min="0" max="10" onchange="updateLikes();"></label>
        <label for="search">Search <input name="search" id="search" type="text" onchange="updateMarkers()"></label>
        <span class="text">This map shows posts from <a target="_blank" href="https://www.facebook.com/groups/Hiddenportlandforthecurious">Hidden Portland for the Curious</a>.<br>More info about this map on <a target="_blank" href="https://github.com/olivierbouwman/hidden-portland">GitHub</a>.</span>
    </div>
    <script>
        var mapData = [];
        var map;
        var markersLayer = new L.LayerGroup();
        getLocation();
        $.getJSON("data.json", function(jsondata) {
            let likesMax = 0;
            let years = [];
            $.each(jsondata, function(index, element) {
                if (element.latlong !== undefined && element.latlong.lat !== undefined) {
                    // We can map this, add it to our list.
                    mapData.push(element);
                    // Find all years.
                    if (Number.isInteger(Number(element.date.substring(0,4))) && years.indexOf(element.date.substring(0,4)) === -1) {
                        years.push(element.date.substring(0,4));
                    }
                    // Find highest number of likes.
                    if (!isNaN(Number(element.likes))) {
                        likesMax = Math.max(likesMax, Number(element.likes));
                    }
                }
            });
            let yearMin = Math.min(...years);
            let yearMax = Math.max(...years);
            document.getElementById("likes").max = likesMax;
            document.getElementById("likes").value = 0;
            document.getElementById("years").max = yearMax;
            document.getElementById("years").min = yearMin;
            document.getElementById("years").value = yearMin;
            updateYears();
        });

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            }
        }

        function showPosition(position) {
            var marker = L.circleMarker([position.coords.latitude,position.coords.longitude], {
                color: '#ff0000',
                radius: 5
            }).bindPopup('This is your current location.');
            markersLayer.addLayer(marker);
            // If current location falls within bounds of Portland, pan there.
            if (position.coords.latitude < 45.687769
                && position.coords.latitude > 45.254888
                && position.coords.longitude > -122.987921
                && position.coords.longitude < -122.203901) {
                map.panTo(new L.LatLng(position.coords.latitude, position.coords.longitude));
            }
        }

        function updateLikes() {
            document.getElementById('likes-text').innerText = "Likes (at least " + document.getElementById('likes').value + ")";
            updateMarkers();
        }

        function updateYears() {
            document.getElementById('years-text').innerText = "Years (starting at " + document.getElementById('years').value + ")";
            updateMarkers();
        }

        function updateMarkers() {
            // Clear all markers.
            markersLayer.clearLayers();
            var search = document.getElementById('search').value;
            $.each(mapData, function(index, element) {
                // Only load markers for selected years.
                if (Number(element.date.substring(0,4)) >= document.getElementById('years').value) {
                    // Only load markers that match our search term.
                    if (search.length === 0 || (search.length > 0 && element.text.toLowerCase().includes(search.toLowerCase()))) {
                        // Only load markers that match our minimum number of likes.
                        if (Number(element.likes) >= document.getElementById('likes').value) {
                            // Create marker.
                            var marker = L.circleMarker([element.latlong.lat,element.latlong.lng], {
                                color: '#3388ff',
                                radius: 10
                            }).bindPopup('Likes: ' + element.likes + ' / Date: ' + element.date + '<br><a target="_blank" href="https://www.facebook.com/groups/Hiddenportlandforthecurious/posts/' + element.id + '">' + element.text + '</a>');
                            markersLayer.addLayer(marker);
                        }
                    }
                }
            });
            markersLayer.addTo(map);
        }
        map = L.map('map', {
            renderer: L.canvas(),
            preferCanvas: true,
            zoomAnimation: false,
            attributionControl: false
        }).setView([45.5230313, -122.6659288], 14);
        var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib2xpdmllcmJvdXdtYW4iLCJhIjoickVlQjBPcyJ9.1yW9yNkaVPQLxet0VsSSBA', {
            maxZoom: 20,
            id: 'mapbox/dark-v10',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);
    </script>
</body>
</html>
